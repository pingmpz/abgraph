<!DOCTYPE html>
{% load static %}
<!--
* CoreUI Pro based Bootstrap Admin Template
* @version v3.2.0
* @link https://coreui.io/pro/
* Copyright (c) 2020 creativeLabs Łukasz Holeczek
* License (https://coreui.io/pro/license)
-->
<html lang="en">
  <head>
    <base href="./">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta name="description" content="CoreUI - Open Source Bootstrap Admin Template">
    <meta name="author" content="Łukasz Holeczek">
    <meta name="keyword" content="Bootstrap,Admin,Template,Open,Source,jQuery,CSS,HTML,RWD,Dashboard">
    <title>Machine Running Time</title>
    <!-- Main styles for this application-->
    <link href="{% static "css/style.css" %}" rel="stylesheet">
    <link href="{% static "vendors/@coreui/chartjs/css/coreui-chartjs.css" %}" rel="stylesheet">
  </head>
  <body class="c-app c-no-layout-transition">
    <div class="c-wrapper">
      <div class="c-body">
        <main class="c-main">
          <div class="container-fluid">
            <div class="fade-in">
              <div class="row">
                <div class="col-4">
                  <div class="row">
                    <div class="col-12">
                      <div class="card" id="card_filter">
                        <div class="card-header"><strong>Filter</strong>
                          <div class="card-header-actions">
                            <button type="button" class="btn btn-link" id="update_data" name="update_data" onclick="update_data()">Update Data</button>
                          </div>
                        </div>
                        <div class="card-body">
                          <div class="form-horizontal">
                            <div class="form-group row">
                              <label class="col-md-4 col-form-label">Graph Type</label>
                              <div class="col-md-8">
                                <select class="form-control" id="type" name="type">
                                  <option value="M">Month</option>
                                  <option value="Y">Year</option>
                                </select>
                              </div>
                            </div>
                            <div class="form-group row">
                              <label class="col-md-4 col-form-label">Year</label>
                              <div class="col-md-8">
                                <input class="form-control" type="text" id="year" name="year" placeholder="Example : 2021" maxlength="4" value="2021">
                              </div>
                            </div>
                            <div class="form-group row" id="month_group">
                              <label class="col-md-4 col-form-label">Month</label>
                              <div class="col-md-8">
                                <select class="form-control" id="month" name="month">
                                  <option value="JAN">January</option>
                                  <option value="FEB">February</option>
                                  <option value="MAR">March</option>
                                  <option value="APR">April</option>
                                  <option value="MAY">May</option>
                                  <option value="JUN">June</option>
                                  <option value="JUL">July</option>
                                  <option value="AUG">August</option>
                                  <option value="SEP">September</option>
                                  <option value="OCT">October</option>
                                  <option value="NOV">November</option>
                                  <option value="DEC">December</option>
                                </select>
                              </div>
                            </div>
                            <div class="form-group row">
                              <label class="col-md-4 col-form-label">Work Center Group</label>
                              <div class="col-md-8">
                                <select class="form-control" id="work_center_group_id" name="work_center_group_id">
                                  <option value="All Work Center Group" selected>All Work Center Group</option>
                                  {% for workcentergroup in workcentergroup_list %}
                                  <option value="{{ workcentergroup.id }}">{{ workcentergroup.name }}</option>
                                  {% endfor %}
                                </select>
                                <input class="form-control" type="text" id="work_center_group_id_count" name="work_center_group_id_count" value="{{workcentergroup_list|length}}" hidden>
                              </div>
                            </div>
                            <div class="form-group row" id="machine_no_group" hidden>
                              <label class="col-md-4 col-form-label">Machine No</label>
                              <div class="col-md-8">
                                <select class="form-control" id="machine_no" name="machine_no">
                                  <option value="All Machine" selected>All Machine ({{machine_list|length}})</option>
                                  {% for machine in machine_list %}
                                  <option value="{{ machine.no }}">{{ machine.no }} | {{ machine.name }}</option>
                                  {% endfor %}
                                </select>
                                <input class="form-control" type="text" id="machine_count" name="machine_count" value="{{machine_list|length}}" hidden>
                              </div>
                            </div>
                            <div class="form-group row">
                              <label class="col-md-9">
                                <div class="form-check checkbox">
                                  <input class="form-check-input" type="checkbox" id="data_error" name="data_error" checked>
                                  <label class="form-check-label" for="data_error">Fixed Error Data <small>― work only on a month graph</small></label>
                                </div>
                                <div class="form-check checkbox">
                                  <input class="form-check-input" type="checkbox" id="auto_execute" name="auto_execute" checked>
                                  <label class="form-check-label" for="auto_execute">Auto Execute</label>
                                </div>
                              </label>
                              <label class="col-md-3 text-right">
                                <button type="button" class="btn btn-primary" id="execute" name="execute" onclick="set_graph_data()" disabled>Execute</button>
                              </label>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- Statistic -->
                    <div class="col-12">
                      <div class="card">
                        <div class="card-header"><strong>Statistic</strong>
                          <div class="card-header-actions"></div>
                        </div>
                        <div class="card-body">
                          <table class="table table-bordered text-center">
                            <thead class="bg-danger">
                              <tr>
                                <th>SHIFT</th>
                                <th>MIN</th>
                                <th>MAX</th>
                                <th>AVERAGE</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <th>DAY</th>
                                <td id="day_min">0</td>
                                <td id="day_max">0</td>
                                <td id="day_avg">0</td>
                              </tr>
                              <tr>
                                <th>NIGHT</th>
                                <td id="night_min">0</td>
                                <td id="night_max">0</td>
                                <td id="night_avg">0</td>
                              </tr>
                              <tr>
                                <th>ALL</th>
                                <td id="all_min">0</td>
                                <td id="all_max">0</td>
                                <td id="all_avg">0</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Machine Running Time -->
                <div class="col-8">
                  <div class="card">
                    <div class="card-header"><strong>Machine Running Time</strong>
                      <div class="card-header-actions"><small id="fetch_time">FETCH DATA AT ― NONE</small></div>
                    </div>
                    <div class="card-body">
                      <div class="c-chart-wrapper">
                        <canvas id="canvas_1"></canvas>
                        <div class="sk-fading-circle" id="loading_spinner" hidden>
                          <div class="sk-circle1 sk-circle" style="height: 400%; width: 400%"></div>
                          <div class="sk-circle2 sk-circle" style="height: 400%; width: 400%"></div>
                          <div class="sk-circle3 sk-circle" style="height: 400%; width: 400%"></div>
                          <div class="sk-circle4 sk-circle" style="height: 400%; width: 400%"></div>
                          <div class="sk-circle5 sk-circle" style="height: 400%; width: 400%"></div>
                          <div class="sk-circle6 sk-circle" style="height: 400%; width: 400%"></div>
                          <div class="sk-circle7 sk-circle" style="height: 400%; width: 400%"></div>
                          <div class="sk-circle8 sk-circle" style="height: 400%; width: 400%"></div>
                          <div class="sk-circle9 sk-circle" style="height: 400%; width: 400%"></div>
                          <div class="sk-circle10 sk-circle" style="height: 400%; width: 400%"></div>
                          <div class="sk-circle11 sk-circle" style="height: 400%; width: 400%"></div>
                          <div class="sk-circle12 sk-circle" style="height: 400%; width: 400%"></div>
                        </div>
                        <div id="loading_space"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
    <!-- CoreUI and necessary plugins-->
    <script src="{% static "vendors/@coreui/coreui-pro/js/coreui.bundle.min.js" %}"></script>
    <!--[if IE]><!-->
    <script src="{% static "vendors/@coreui/icons/js/svgxuse.min.js" %}"></script>
    <!--<![endif]-->
    <script src="{% static "vendors/jquery/js/jquery.min.js" %}"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.4.0/chart.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.0.2/chartjs-plugin-annotation.min.js"></script>
    <!-- <script src="static/vendors/@coreui/chartjs/js/coreui-chartjs.bundle.js"></script> -->
    <script src="{% static "js/charts.js" %}"></script>
    <script src="{% static "js/loading-buttons.js" %}"></script>
    <!-- <script src="index.js"></script> -->
    <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function(event) {
        setTimeout(function() {
          document.body.classList.remove('c-no-layout-transition')
        }, 2000);
      });

      $( document ).ready(function() {
          var currentdate = new Date();
          $("#year").val(currentdate.getFullYear());
          $("#month").val(month_set[currentdate.getMonth()]);
          set_graph_data();
      });

      //-- DATA
      const month_set = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
      const full_month_set = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      var chart_type = 'bar';
      var title = 'No Machine';
      var sub_title = 'No Date';
      var y_title = 'Minutes';
      var x_title = 'Date';
      var x_count = 30;
      var labels = [];
      var data = {};
      var day_shift = [];
      var night_shift = [];
      var day_bar_color = ['rgb(249,213,110)'];
      var day_bar_border_color = [];
      var night_bar_color = ['rgb(130,177,254)'];
      var night_bar_border_color = [];
      var line_1_color = ['rgb(255,255,255,0)'];
      var line_2_color = ['rgb(255,255,255,0)'];
      var footer = (tooltipItems) => {
          let sum = i = 0;
          let data = [0, 0];
          tooltipItems.forEach(function(tooltipItem) {
            data[i] = tooltipItem.parsed.y;
            sum += tooltipItem.parsed.y;
            i++;
          });
          return 'Day Shift (Hours) ― ' + Math.floor(data[0]/60) + ":" + addZero(data[0]%60)
          + '\nNight Shift (Hours) ― ' + Math.floor(data[1]/60) + ":" + addZero(data[1]%60)
          + '\nTotal Minutes ― ' + numberWithCommas(sum)
          + '\nTotal Hours ― ' + Math.floor(sum/60) + ":" + addZero(sum%60);
      };

      var config = {
        type: chart_type,
        data: data,
        plugins: [ChartDataLabels],
        options: {
          plugins: {
            title: {
              display: true,
              text: title
            },
            subtitle: {
                display: true,
                text: sub_title
            },
            tooltip: {
              callbacks: {
                footer: footer,
              }
            },
            autocolors: false,
            annotation: {
                annotations: [{
                    id: '720',
                    type: 'line',
                    mode: 'horizontal',
                    yMin: 720,
                    yMax: 720,
                    borderColor: line_1_color,
                    borderWidth: 1,
                },
                {
                    id: '1440',
                    type: 'line',
                    mode: 'horizontal',
                    yMin: 1440,
                    yMax: 1440,
                    borderColor: line_2_color,
                    borderWidth: 1,
                }]
            },
            datalabels: {
          		formatter: (value, ctx) => {
          			let datasets = ctx.chart.data.datasets; // Tried `.filter(ds => !ds._meta.hidden);` without success
                var type = $('#type').val();
                var machine_no = $('#machine_no').val();
            		if (ctx.datasetIndex === datasets.length - 1) {
            			let sum = 0;
            			datasets.map(dataset => {
            				sum += dataset.data[ctx.dataIndex];
            			});
                  result = Math.floor((sum/1440)*100) + "%";
                  if(Math.floor((sum/1440)*100) == 0) result = "";
                  if(machine_no == "All Machine" || type == "Y") result = "";
            			return result;
            		}
            		else {
            			return '';
            		}
          		},
          		anchor: 'end',
          		align: 'end'
          	}
          },
          responsive: true,
          scales: {
            x: {
              stacked: true,
              title: {
                display: true,
                text: x_title
              }
            },
            y: {
              stacked: true,
              title: {
                display: true,
                text: y_title
              }
            }
          }
        },
      };

      var barChart = new Chart(document.getElementById('canvas_1'), config);

      //-- MAIN FUNCTION
      function set_graph_data(){
        preload();
        var type = $('#type').val();
        var year = $('#year').val();
        var month = $('#month').val();
        var work_center_group_id = $('#work_center_group_id').val();
        var work_center_group_id_count = $('#work_center_group_id_count').val();
        var machine_no = $('#machine_no').val();
        var machine_count = $('#machine_count').val();
        if(type == "Y"){
          sub_title = year;
          x_count = 12;
          labels = month_set;
          x_title = 'Month';
        } else if(type == "M"){
          sub_title = full_month_set[month_set.indexOf(month)] + " " + year;
          x_count = get_date_count();
          labels = get_date_labels();
          x_title = 'Date';
        }
        if(work_center_group_id == "All Work Center Group") title = "Machine : All Machine From All Work Center Group";
        else if(machine_no == "All Machine") title = "Machine : All Machine From " + get_wcg_name(work_center_group_id);
        else title = "Machine : " + machine_no;
        set_data();
      }

      function set_data(){
        get_data('DAY', function(result, error_result) {
          day_shift = result;
          set_bar_color('DAY', error_result);
          get_data('NIGHT', function(result, error_result) {
            night_shift = result;
            set_bar_color('NIGHT', error_result);
            data = {
              labels: labels,
              datasets: [
              {
                label: 'Day Shift ',
                type: 'bar',
                backgroundColor: day_bar_color,
                borderColor: day_bar_border_color,
                borderWidth: 1,
                data: day_shift
              },
              {
                label: 'Night Shift ',
                type: 'bar',
                backgroundColor: night_bar_color,
                borderColor: night_bar_border_color,
                borderWidth: 1,
                data: night_shift
              },
            ]
            };
            var currentdate = new Date();
            var datetime = currentdate.getDate() + "/" + (currentdate.getMonth()+1)  + "/" + currentdate.getFullYear() + " @ " + currentdate.getHours() + ":" + currentdate.getMinutes() + ":" + currentdate.getSeconds();
            set_statistic();
            set_line_color();
            barChart.data.labels = labels;
            barChart.data = data;
            barChart.options.plugins.subtitle.text = sub_title;
            barChart.options.plugins.title.text = title;
            barChart.options.scales.x.title.text = x_title;
            barChart.update();
            postload(datetime);
          });
        });
      }

      function get_data(shift, callback){
        var type = $('#type').val();
        var year = $('#year').val();
        var month = $('#month').val();
        var work_center_group_id = $('#work_center_group_id').val();
        var work_center_group_id_count = $('#work_center_group_id_count').val();
        var machine_no = $('#machine_no').val();
        var machine_count = $('#machine_count').val();
        var data_error = 'TRUE';
        if($('#data_error').is(":checked")){
          data_error = 'FALSE';
        }
        $.ajax({
          url: '/get_data/',
          data: {
            'shift' : shift,
            'x_count' : x_count,
            'type': type,
            'year': year,
            'month': month,
            'work_center_group_id': work_center_group_id,
            'machine_no': machine_no,
            'data_error' : data_error,
          },
          dataType: 'json',
          success: function (data) {
            var result = [];
            var error_result = [];
            result = data.result;
            error_result = data.error_result;
            callback(result, error_result);
          }
        });
      }

      function set_line_color(){
        var type = $('#type').val();
        var machine_no = $('#machine_no').val();
        if(machine_no == "All Machine" || type == "Y"){
          barChart.options.plugins.annotation.annotations[0].borderColor = 'rgb(255,255,255,0)';
          barChart.options.plugins.annotation.annotations[1].borderColor = 'rgb(255,255,255,0)';
        } else {
          barChart.options.plugins.annotation.annotations[0].borderColor = 'rgb(0,0,0)';
          barChart.options.plugins.annotation.annotations[1].borderColor = 'rgb(0,0,0)';
        }
      }

      function set_bar_color(shift, error_result){
        // DAY = 'rgb(249,213,110)' , NIGHT = 'rgb(130,177,254)' , RED 'rgb(249,213,110)', BLACK 'rgb(0,0,0)', WHITE 'rgb(255,255,255)'
        if(shift == 'DAY'){
          day_bar_border_color = [];
          for(var i = 0;i < error_result.length;i++){
            if(error_result[i] == true){
              day_bar_border_color.push('rgb(255,0,0)');
            } else {
              day_bar_border_color.push('rgb(249,213,110)');
            }
          }
        } else {
          night_bar_border_color = [];
          for(var i = 0;i < error_result.length;i++){
            if(error_result[i] == true){
              night_bar_border_color.push('rgb(255,0,0)');
            } else {
              night_bar_border_color.push('rgb(130,177,254)');
            }
          }
        }
      }

      function set_statistic(){
        $('#day_min').html(Math.min(...day_shift));
        $('#day_max').html(Math.max(...day_shift));
        var sum = day_shift.reduce((a, b) => a + b, 0);
        var avg = (sum / day_shift.length) || 0;
        $('#day_avg').html(Math.round((avg + Number.EPSILON) * 100) / 100);
        $('#night_min').html(Math.min(...night_shift));
        $('#night_max').html(Math.max(...night_shift));
        var sum = night_shift.reduce((a, b) => a + b, 0);
        var avg = (sum / night_shift.length) || 0;
        $('#night_avg').html(Math.round((avg + Number.EPSILON) * 100) / 100);
        var all_shift = [];
        for(var i = 0;i < day_shift.length;i++){
          all_shift.push(day_shift[i] + night_shift[i]);
        }
        $('#all_min').html(Math.min(...all_shift));
        $('#all_max').html(Math.max(...all_shift));
        var sum = all_shift.reduce((a, b) => a + b, 0);
        var avg = (sum / all_shift.length) || 0;
        $('#all_avg').html(Math.round((avg + Number.EPSILON) * 100) / 100);
      }

      function update_data(){
        $.ajax({
          url: '/update_data/',
          data: {
          },
          dataType: 'json',
          success: function (data) {
            location.reload();
          }
        });
      }

      $('#type').change(function() {
        toggleMonthGroup();
        if($('#type').val() == "Y"){
          $('#data_error').prop("disabled", true);
          $('#data_error').prop("checked", false);
        } else {
          $('#data_error').prop("disabled", false);
        }
        if($('#auto_execute').is(":checked")){
          set_graph_data();
        }
      });

      $('#year').on("keypress keyup keydown",function() {
        var year = $('#year').val();
        if(year.length == 4){
          if($('#auto_execute').is(":checked")){
            set_graph_data();
          }
          $('#year').removeClass("is-invalid");
          $('#year').addClass("is-valid");
        } else {
          $('#year').removeClass("is-valid");
          $('#year').addClass("is-invalid");
        }
      });

      $('#month').change(function() {
        if($('#auto_execute').is(":checked")){
          set_graph_data();
        }
      });

      $('#work_center_group_id').change(function() {
        toggleMachineNoGroup();
        set_machine_list(function(machine_list){
          $('#machine_no').empty();
          var opt = document.createElement('option');
          opt.appendChild(document.createTextNode("All Machine (" + machine_list.length + ")"));
          opt.value = "All Machine";
          machine_no.appendChild(opt);
          for(var i = 0;i < machine_list.length;i++){
            opt = document.createElement('option');
            opt.appendChild( document.createTextNode(machine_list[i][0] + " | " + machine_list[i][1]));
            opt.value = machine_list[i][0];
            machine_no.appendChild(opt);
          }
          $('#machine_count').val(machine_list.length);
          if($('#auto_execute').is(":checked")){
            set_graph_data();
          }
        });
      });

      function set_machine_list(callback){
        var work_center_group_id = $('#work_center_group_id').val();
        $.ajax({
          url: '/get_machine_list/',
          data: {
            'work_center_group_id' : work_center_group_id,
          },
          dataType: 'json',
          success: function (data) {
            callback(data.machine_list);
          }
        });
      }

      $('#machine_no').change(function() {
        if($('#auto_execute').is(":checked")){
          set_graph_data();
        }
      });

      $('#data_error').change(function() {
        if($('#auto_execute').is(":checked")){
          set_graph_data();
        }
      });

      $('#auto_execute').change(function() {
        if($('#auto_execute').is(":checked")){
          set_graph_data();
        }
      });

      function toggleMonthGroup(){
        var type = $('#type').val();
        if(type == "M") {
          $('#month_group').prop('hidden', false);
        } else {
          $('#month_group').prop('hidden', true);
        }
      }

      function toggleMachineNoGroup(){
        var work_center_group_id = $('#work_center_group_id').val();
        if(work_center_group_id != "All Work Center Group") {
          $('#machine_no_group').prop('hidden', false);
        } else {
          $('#machine_no_group').prop('hidden', true);
        }
        $('#machine_no').val('All Machine');
      }

      $('#auto_execute').change(function() {
        if(this.checked) $('#execute').prop("disabled", true);
        else $('#execute').prop("disabled", false);
      });

      // OTHER FUNCTION
       function get_date_count(){
         var year = $('#year').val();
         var month = $('#month').val();
         if(month == "FEB" && (parseInt(year)%4) == 0) return 29;
         else if(month == "FEB") return 28;
         else if(month == "JAN" || month == "MAR" || month == "MAY" || month == "JUL" || month == "AUG" || month == "OCT" || month == "DEC") return 31;
         return 30;
       }

       function get_date_labels(){
         var result = [];
         for(i = 1;i < x_count + 1;i++){
           result.push(i);
         }
         return result;
       }

       function get_wcg_name(id){
         var result = "None";
         result = $("#work_center_group_id option[value='" + id + "']").text();
         return result;
       }

       function preload(){
         $('#fetch_time').html("FETCHING DATA ...");
         $('#loading_spinner').prop("hidden", false)
         $('#loading_space').prop("hidden", false)
         $('#canvas_1').prop("hidden", true)
       }

       function postload(datetime){
         $('#fetch_time').html("FETCH DATA AT ― " + datetime);
         $('#loading_spinner').prop("hidden", true);
         $('#loading_space').prop("hidden", true);
         $('#canvas_1').prop("hidden", false);
       }

       $("#year").on("keypress keyup blur",function (event) {
           $(this).val($(this).val().replace(/[^\d].+/, ""));
            if ((event.which < 48 || event.which > 57)) {
                event.preventDefault();
            }
        });

       function numberWithCommas(x) {
          return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
       }

       function addZero(x){
         if(x < 10) return "0" + x
         return x;
       }
    </script>
  </body>
</html>
