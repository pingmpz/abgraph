<!DOCTYPE html>
{% load static %}
<!--
* CoreUI Pro based Bootstrap Admin Template
* @version v3.2.0
* @link https://coreui.io/pro/
* Copyright (c) 2020 creativeLabs Łukasz Holeczek
* License (https://coreui.io/pro/license)
-->
<html lang="en">
  <head>
    <base href="./">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta name="description" content="CoreUI - Open Source Bootstrap Admin Template">
    <meta name="author" content="Łukasz Holeczek">
    <meta name="keyword" content="Bootstrap,Admin,Template,Open,Source,jQuery,CSS,HTML,RWD,Dashboard">
    <title>Machine Running Time</title>
    <!-- Main styles for this application-->
    <link href="{% static "css/style.css" %}" rel="stylesheet">
    <link href="{% static "vendors/@coreui/chartjs/css/coreui-chartjs.css" %}" rel="stylesheet">
  </head>
  <body class="c-app c-no-layout-transition">
    <div class="c-wrapper">
      <div class="c-body">
        <main class="c-main">
          <div class="container-fluid">
            <div class="fade-in">
              <div class="row">
                <div class="col-4">
                  <div class="row">
                    <!-- Option -->
                    <div class="col-12">
                      <div class="card">
                        <div class="card-header"><strong>Option</strong>
                          <div class="card-header-actions"></div>
                        </div>
                        <div class="card-body">
                          <div class="form-horizontal">
                            <div class="form-group row">
                              <label class="col-md-4 col-form-label">Graph Type</label>
                              <div class="col-md-8">
                                <select class="form-control" id="type" name="type">
                                  <option value="M">Month</option>
                                  <option value="Y">Year</option>
                                </select>
                              </div>
                            </div>
                            <div class="form-group row">
                              <label class="col-md-4 col-form-label">Year</label>
                              <div class="col-md-8">
                                <input class="form-control" type="text" id="year" name="year" placeholder="Example : 2021" maxlength="4" value="2021">
                              </div>
                            </div>
                            <div class="form-group row" id="month_group">
                              <label class="col-md-4 col-form-label">Month</label>
                              <div class="col-md-8">
                                <select class="form-control" id="month" name="month">
                                  <option value="JAN">January</option>
                                  <option value="FEB">February</option>
                                  <option value="MAR">March</option>
                                  <option value="APR">April</option>
                                  <option value="MAY">May</option>
                                  <option value="JUN">June</option>
                                  <option value="JUL">July</option>
                                  <option value="AUG">August</option>
                                  <option value="SEP">September</option>
                                  <option value="OCT">October</option>
                                  <option value="NOV">November</option>
                                  <option value="DEC">December</option>
                                </select>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- Machine -->
                    <div class="col-12">
                      <div class="card">
                        <div class="card-header"><strong>Machine</strong>
                          <div class="card-header-actions"></div>
                        </div>
                        <div class="card-body">
                          <div class="form-horizontal">
                            <div class="form-group row">
                              <label class="col-md-4 col-form-label">Work Center Group</label>
                              <div class="col-md-8">
                                <select class="form-control" id="work_center_group" name="work_center_group">
                                  <option value="All Work Center Group" selected>All Work Center Group</option>
                                  {% for workcentergroup in workcentergroup_list %}
                                  <option value="{{ workcentergroup.WorkCenterGroup }}">{{ workcentergroup.WorkCenterGroup }}</option>
                                  {% endfor %}
                                </select>
                                <input class="form-control" type="text" id="work_center_group_count" name="work_center_group_count" value="{{workcentergroup_list|length}}" hidden>
                              </div>
                            </div>
                            <div class="form-group row" id="machine_no_group" hidden>
                              <label class="col-md-4 col-form-label">Machine No</label>
                              <div class="col-md-8">
                                <select class="form-control" id="machine_no" name="machine_no">
                                  <option value="All Machine" selected>All Machine ({{machine_list|length}})</option>
                                  {% for machine in machine_list %}
                                  <option value="{{ machine.MachineNumber }}">{{ machine.MachineNumber }} | {{ machine.MachineName }}</option>
                                  {% endfor %}
                                </select>
                                <input class="form-control" type="text" id="machine_count" name="machine_count" value="{{machine_list|length}}" hidden>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- Statistic -->
                    <div class="col-12">
                      <div class="card">
                        <div class="card-header"><strong>Statistic</strong>
                          <div class="card-header-actions"></div>
                        </div>
                        <div class="card-body">
                          <table class="table table-bordered text-center">
                            <thead class="bg-danger">
                              <tr>
                                <th>SHIFT</th>
                                <th>MIN</th>
                                <th>MAX</th>
                                <th>AVERAGE</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <th>DAY</th>
                                <td id="day_min">0</td>
                                <td id="day_max">0</td>
                                <td id="day_avg">0</td>
                              </tr>
                              <tr>
                                <th>NIGHT</th>
                                <td id="night_min">0</td>
                                <td id="night_max">0</td>
                                <td id="night_avg">0</td>
                              </tr>
                              <tr>
                                <th>ALL</th>
                                <td id="all_min">0</td>
                                <td id="all_max">0</td>
                                <td id="all_avg">0</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Machine Running Time -->
                <div class="col-8">
                  <div class="card">
                    <div class="card-header"><strong>Machine Running Time</strong>
                      <div class="card-header-actions"><small>FETCH DATA AT ― <span id="fetch_time">NONE</span></small></div>
                    </div>
                    <div class="card-body">
                      <div class="c-chart-wrapper">
                        <canvas id="canvas_1"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
    <!-- CoreUI and necessary plugins-->
    <script src="{% static "vendors/@coreui/coreui-pro/js/coreui.bundle.min.js" %}"></script>
    <!--[if IE]><!-->
    <script src="{% static "vendors/@coreui/icons/js/svgxuse.min.js" %}"></script>
    <!--<![endif]-->
    <script src="{% static "vendors/jquery/js/jquery.min.js" %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.4.0/chart.min.js"></script>
    <!-- <script src="static/vendors/@coreui/chartjs/js/coreui-chartjs.bundle.js"></script> -->
    <script src="{% static "js/charts.js" %}"></script>
    <!-- <script src="index.js"></script> -->
    <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function(event) {
        setTimeout(function() {
          document.body.classList.remove('c-no-layout-transition')
        }, 2000);
      });

      $( document ).ready(function() {
          var currentdate = new Date();
          $("#year").val(currentdate.getFullYear());
          $("#month").val(month_set[currentdate.getMonth()]);
          set_graph_data();
      });

      //-- DATA
      const month_set = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
      const full_month_set = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      var chart_type = 'bar';
      var title = 'No Machine';
      var sub_title = 'No Date';
      var y_title = 'Hour';
      var x_title = 'Date';
      var min = 0;
      var max = 24;
      var x_count = 30;
      var labels = [];
      var data = {};
      var day_shift = [];
      var night_shift = [];
      var footer = (tooltipItems) => {
          let sum = 0;
          tooltipItems.forEach(function(tooltipItem) {
            sum += tooltipItem.parsed.y;
          });
          return 'Total : ' + sum;
      };
      var config = {
        type: chart_type,
        data: data,
        options: {
          plugins: {
            title: {
              display: true,
              text: title
            },
            subtitle: {
                display: true,
                text: sub_title
            },
            tooltip: {
              callbacks: {
                footer: footer,
              }
            }
          },
          responsive: true,
          scales: {
            x: {
              stacked: true,
              title: {
                display: true,
                text: x_title
              }
            },
            y: {
              stacked: true,
              min: min,
              max: max,
              title: {
                display: true,
                text: y_title
              }
            }
          }
        },
      };

      var barChart = new Chart(document.getElementById('canvas_1'), config);

      //-- FUNCTION
      function get_date_count(){
        var year = $('#year').val();
        var month = $('#month').val();
        if(month == "FEB" && (parseInt(year)%4) == 0) return 29;
        else if(month == "FEB") return 28;
        else if(month == "JAN" || month == "MAR" || month == "MAY" || month == "JUL" || month == "AUG" || month == "OCT" || month == "DEC") return 31;
        return 30;
      }

      function get_date_labels(){
        var result = [];
        for(i = 1;i < x_count + 1;i++){
          result.push(i);
        }
        return result;
      }

      function get_data(shift, callback){
        var type = $('#type').val();
        var year = $('#year').val();
        var month = $('#month').val();
        var work_center_group = $('#work_center_group').val();
        var work_center_group_count = $('#work_center_group_count').val();
        var machine_no = $('#machine_no').val();
        var machine_count = $('#machine_count').val();
        $.ajax({
          url: '/get_data/',
          data: {
            'shift' : shift,
            'x_count' : x_count,
            'type': type,
            'year': year,
            'month': month,
            'work_center_group': work_center_group,
            'work_center_group_count': work_center_group_count,
            'machine_no': machine_no,
            'machine_count': machine_count,
          },
          dataType: 'json',
          success: function (data) {
            var result = [];
            result = data.result;
            callback(result);
          }
        });
      }

      function set_data(){
        get_data('DAY', function(result) {
          day_shift = result;
          get_data('NIGHT', function(result) {
            night_shift = result;
            data = {
              labels: labels,
              datasets: [
              {
                label: 'Day Shift ',
                backgroundColor: 'rgb(249,213,110)',
                borderColor: 'rgb(249,213,110)',
                data: day_shift
              },
              {
                label: 'Night Shift ',
                backgroundColor: 'rgb(130,177,254)',
                borderColor: 'rgb(130,177,254)',
                data: night_shift
              },
            ]
            };
            var currentdate = new Date();
            var datetime = currentdate.getDate() + "/" + (currentdate.getMonth()+1)  + "/" + currentdate.getFullYear() + " @ " + currentdate.getHours() + ":" + currentdate.getMinutes() + ":" + currentdate.getSeconds();
            $('#fetch_time').html(datetime);
            set_statistic();
            barChart.data.labels = labels;
            barChart.data = data;
            barChart.options.plugins.subtitle.text = sub_title;
            barChart.options.plugins.title.text = title;
            barChart.options.scales.y.max = max;
            barChart.options.scales.x.title.text = x_title;
            barChart.update();
          });
        });
      }

      function set_graph_data(){
        var type = $('#type').val();
        var year = $('#year').val();
        var month = $('#month').val();
        var work_center_group = $('#work_center_group').val();
        var work_center_group_count = $('#work_center_group_count').val();
        var machine_no = $('#machine_no').val();
        var machine_count = $('#machine_count').val();
        if(type == "Y"){
          sub_title = year;
          x_count = 12;
          labels = month_set;
          if(work_center_group == "All Work Center Group") max = 744 * parseInt(machine_count) * parseInt(work_center_group_count);
          else if(machine_no == "All Machine") max = 744 * parseInt(machine_count);
          else max = 744;
          x_title = 'Month';
        } else if(type == "M"){
          sub_title = full_month_set[month_set.indexOf(month)] + " " + year;
          x_count = get_date_count();
          labels = get_date_labels();
          if(work_center_group == "All Work Center Group") max = 24 * parseInt(machine_count) * parseInt(work_center_group_count);
          else if(machine_no == "All Machine") max = 24 * parseInt(machine_count);
          else max = 24;
          x_title = 'Date';
        }
        if(work_center_group == "All Work Center Group") title = "Machine : All Machine From All Work Center Group";
        else if(machine_no == "All Machine") title = "Machine : All Machine From " + work_center_group;
        else title = "Machine : " + machine_no;
        set_data();
      }

      function set_statistic(){
        $('#day_min').html(Math.min(...day_shift));
        $('#day_max').html(Math.max(...day_shift));
        var sum = day_shift.reduce((a, b) => a + b, 0);
        var avg = (sum / day_shift.length) || 0;
        $('#day_avg').html(Math.round((avg + Number.EPSILON) * 100) / 100);
        $('#night_min').html(Math.min(...night_shift));
        $('#night_max').html(Math.max(...night_shift));
        var sum = night_shift.reduce((a, b) => a + b, 0);
        var avg = (sum / night_shift.length) || 0;
        $('#night_avg').html(Math.round((avg + Number.EPSILON) * 100) / 100);
        var all_shift = [];
        for(var i = 0;i < day_shift.length;i++){
          all_shift.push(day_shift[i] + night_shift[i]);
        }
        $('#all_min').html(Math.min(...all_shift));
        $('#all_max').html(Math.max(...all_shift));
        var sum = all_shift.reduce((a, b) => a + b, 0);
        var avg = (sum / all_shift.length) || 0;
        $('#all_avg').html(Math.round((avg + Number.EPSILON) * 100) / 100);
      }

      $('#type').change(function() {
        toggleMonthGroup();
        set_graph_data();
      });

      $('#year').on("keypress keyup keydown",function() {
        var year = $('#year').val();
        if(year.length == 4){
          set_graph_data();
          $('#year').removeClass("is-invalid");
          $('#year').addClass("is-valid");
        } else {
          $('#year').removeClass("is-valid");
          $('#year').addClass("is-invalid");
        }
      });

      $('#month').change(function() {
        set_graph_data();
      });

      $('#work_center_group').change(function() {
        toggleMachineNoGroup();
        set_machine_list(function(machine_list){
          console.log(machine_list);
          $('#machine_no').empty();
          var opt = document.createElement('option');
          opt.appendChild(document.createTextNode("All Machine (" + machine_list.length + ")"));
          opt.value = "All Machine";
          machine_no.appendChild(opt);
          for(var i = 0;i < machine_list.length;i++){
            opt = document.createElement('option');
            opt.appendChild( document.createTextNode(machine_list[i][0] + " | " + machine_list[i][1]));
            opt.value = machine_list[i][0];
            machine_no.appendChild(opt);
          }
          $('#machine_count').val(machine_list.length);
          set_graph_data();
        });
      });

      $('#machine_no').change(function() {
        set_graph_data();
      });

      function toggleMonthGroup(){
        var type = $('#type').val();
        if(type == "M") {
          $('#month_group').prop('hidden', false);
        } else {
          $('#month_group').prop('hidden', true);
        }
      }

      function toggleMachineNoGroup(){
        var work_center_group = $('#work_center_group').val();
        if(work_center_group != "All Work Center Group") {
          $('#machine_no_group').prop('hidden', false);
          $('#machine_no').val('All Machine');
        } else {
          $('#machine_no_group').prop('hidden', true);
        }
      }

      function set_machine_list(callback){
        var work_center_group = $('#work_center_group').val();
        $.ajax({
          url: '/get_machine_list/',
          data: {
            'work_center_group' : work_center_group,
          },
          dataType: 'json',
          success: function (data) {
            callback(data.machine_list);
          }
        });
      }

      $("#year").on("keypress keyup blur",function (event) {
          $(this).val($(this).val().replace(/[^\d].+/, ""));
           if ((event.which < 48 || event.which > 57)) {
               event.preventDefault();
           }
       });
    </script>
  </body>
</html>
